{"componentChunkName":"component---src-templates-post-template-tsx","path":"/static 과 Thread/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h2>static ?</h2>\n<hr>\n<p>명확한 장점으로 인해 성능을 고도화를 위해 쉽게 고려되지만, 다양한 경로에서 야기될 수 있는 문제점으로 인해<br>\n<em>모르면 쓰지 마라</em>\n가 중론이 되는 개념 중 하나인 것 같다.</p>\n<p>보다 그 이점과 주의점을 명확하게 하여, 적재적소에 사용하고자 정리해 보도록 하자<br>\n(무서워서 안 쓸 수는 없다…)</p>\n<h3>개념</h3>\n<p><em>static : 정적인, 움직이지 않는</em></p>\n<p>크게 와닿진 않되, 어떤 의미로 사용되었는지는 알 것 같은 단어이다.</p>\n<p>클래스에서 static으로 선언한 변수는 찍어낸 객체에서 존재하는 변수가 아닌, 클래스 주소에 위치 한 클래스 변수이다.<br>\n이 말인즉슨, 해당 클래스의 생성자로 찍어낸 모든 객체가 동일한 주소의 클래스 변수를 참조한다는 의미이다.</p>\n<p>해당 개념을 확인해 보기 위해 주로 사용되는 코드는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">StaticSample</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> val <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">StaticSample</span> sam1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StaticSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                sam1<span class=\"token punctuation\">.</span>val<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">StaticSample</span> sam2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StaticSample</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                sam2<span class=\"token punctuation\">.</span>val<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>sam1<span class=\"token punctuation\">.</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>sam2<span class=\"token punctuation\">.</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 개념으로부터 확인 할 수 있는 static의 명확한 장점은</p>\n<p><strong>중복되는 변수, 객체의 메모리 할당을 방지할 수 있다</strong></p>\n<p>는 점이다.</p>\n<p>이로 인한 메모리 관점의 이점 외에도 기능적인 이유로도 사용되기도 한다.</p>\n<p>만약 여러 클래스에서 공통적으로 사용 될 수도 있는이 아니라, 공통으로 사용해야만 하는 데이터 들에 대해 (eg. 사용자 session 등)<br>\n구현 할 때도 고려된다.</p>\n<p>해당 기능을 구현하기 위한 패턴이 <strong>Singleton pattern</strong>이다.</p>\n<blockquote>\n<p>클래스 내부의 static 변수의 사용이 아닌, static class 즉, 여러 객체를 찍어 낼 수 없게 구현하기 위해서는 아래와 같이 생성자를 private 으로 접근 제어 후 내부 get… 를 통해 유일한 static 객체를 사용되게 만들 수 있다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Singleton</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Singleton</span> st<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">private</span> <span class=\"token class-name\">Singleton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">SingletonGetInstatnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> st<span class=\"token punctuation\">;</span> \n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\t</code></pre></div>\n<blockquote>\n<p>static method 는</p>\n<ol>\n<li>객체를 생성하여 호출할 필요가 없이, 클래스 명을 통해 호출이 가능하다.     ( eg. <code class=\"language-text\">Singleton.SingletonGetInstatnce()</code>)</li>\n<li>같은 클래스를 통해 생성된 객체들 간 같은 메서드를 참조하는 것을 보장하기 위해 사용 (Override 가 불가능 한 이유이다.)</li>\n</ol>\n</blockquote>\n<h2>왜 주의해야 할까</h2>\n<hr>\n<p>위에서 언급된 개념을 통해 얻어진 이점이 그대로 주의점이 되어 돌아올 수 있다.</p>\n<p>언급된 개념을 다시 살펴보자</p>\n<blockquote>\n<p>클래스에서 static 으로 선언한 변수는 찍어낸 객체 주소에 존재하는 변수가 아닌, 클래스 주소에 위치 한 클래스 변수이다.\n이 말인즉슨, 해당 클래스의 생성자로 찍어낸 모든 객체가  동일한 주소의 클래스 변수를 참조한다는 의미이다.</p>\n</blockquote>\n<h3>1. 유일한 변수를 쳐다본다. 그 유일한 변수가 수정이 일어나게 되면?</h3>\n<p>위의  StaticSample 예제 코드에서도 확인이 가능했듯이 찍어낸 모든 객체가,<br>\n<strong>class 메모리 주소에 존재</strong>하는 유일한 static 변수를 참조하기 때문에,</p>\n<p><em>어디서 수정이 되었든 모든 찍어진 객체에서  사용되는 static 변수의 값이 수정된다.</em></p>\n<p>당연히 이를 위해서 static 변수를 사용한 것이겠지만, 명확한 의도를 이해하고, 또 이해 가능하게 작성해야 한다.</p>\n<p>잘못 사용된 좋은 예제가 있어 인용하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BadQueryManager</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> queryURL <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token class-name\">BadQueryManager</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> badUrl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tqueryURL <span class=\"token operator\">=</span> badUrl<span class=\"token punctuation\">;</span> \n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getSql</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> idSql<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t\t\treader<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>queryURL<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> ex<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 코드가 야기하는 문제는 무엇일까.</p>\n<p>여러 Thread 에서 해당 static url 변수를 사용하기 위해서, 해당 객체를 <code class=\"language-text\">생성자(queryURL)</code> 을 통해 찍어 getSql 메서드를 을 사용하게 되면<br>\n생성자 로직에 의해 BadQueryManager 의 static String queryURL 이 변경 되게 되므로 시점에 따라</p>\n<p><strong>다른 Thread 에서는 영문도 모른 채 바뀐 queryURL</strong> 을 통해 getSql 로직 결과를 반환 받게 되는 것 이다.</p>\n<p>따라서 명확한 의도를 가지고 사용해야 하는 것이 static 이다.</p>\n<p>위의 경우에서도 언제나 변한 없는 값을 위한 URL 을 원하는 경우</p>\n<ol>\n<li><code class=\"language-text\">static final</code> 을 통해 값의 할당이 최초에만 될 수 있게 하거나, (적어도 값의 변경을 시도 할 때 에러라도 내서 수정 할 수 있게…)</li>\n<li><code class=\"language-text\">private BadQueryManager{ ... }</code> 를 통해 생성자를 막아버려 싱글톤으로 구현</li>\n</ol>\n<p>할 수도  있을 것 같다.</p>\n<p>좌우지간 관습적으로 이럴 경우 이렇게… 식으로의 코드 작성 보다 해당 기능이 원하는 명확한 요구 사항을 파악한 후에\n올바른 코드 작성을 해야 하는 것 같다</p>\n<br>\n<p>위의 문제는 동일 JVM에서도 발생할 수 있는 경우이다.<br>\n하지만, MSA 를 통해 여러 대의 WAS 생성하여 수평 확장을 통해 성능개선 하는 것이 대두되는 요즘 또 다른 문제점이 발생한다.</p>\n<p>당연하겠지만,</p>\n<ul>\n<li>다른 JVM 에서는 static 이라 하더라도 다른 주소나 다른 값을 참조한다.</li>\n</ul>\n<p>이의 주의점은 JVM이 로드 되는 시점이 상이한 환경에서<br>\n로드되는 시점 한번에 읽어드려 static 변수로 관리하고자 하였던, 데이터의 값들이<br>\n시점, 각 JVM 에서 이루어진 static data 수정으로 인해, JVM 별 static 변수 data 값이 다를 수도 있다는 점이다.</p>\n<p>이를 해결하기 위해서</p>\n<ul>\n<li>static 변수의 값이 수정 될 경우 모든 서버를 재시작하는 등</li>\n</ul>\n<p>을 고려할 수 있지만, 딱 봐도 무시무시한 방법이기에 JVM 간의 static 한 변수, 데이터를 사용하기 위해서<br>\n<strong>캐시 서버</strong>를 통해 확장성 있는 설계를 구성할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 768px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9974a4bfa9c09de714f8534014cc1eec/d057b/static_cache.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 101.5625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB6qIjVUZwGoP/xAAaEAEBAAIDAAAAAAAAAAAAAAABABARITFB/9oACAEBAAEFAmHccTl79L//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAbEAEAAwEAAwAAAAAAAAAAAAABABEhMVFhcf/aAAgBAQABPyHwtZ0HJhV39j9wdYbBYlZ1hAyf/9oADAMBAAIAAwAAABBr8L//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAcEAEBAQADAAMAAAAAAAAAAAABEQAhMUFRYXH/2gAIAQEAAT8QKXsHlxc5rriZ9p9u2ZshuQZWMh8ZAo38dY1I+PeeV4SXKICtZ67/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9974a4bfa9c09de714f8534014cc1eec/a59e9/static_cache.webp 192w,\n/static/9974a4bfa9c09de714f8534014cc1eec/0ca9f/static_cache.webp 384w,\n/static/9974a4bfa9c09de714f8534014cc1eec/dc9b9/static_cache.webp 768w,\n/static/9974a4bfa9c09de714f8534014cc1eec/e2c2f/static_cache.webp 1152w,\n/static/9974a4bfa9c09de714f8534014cc1eec/f3efb/static_cache.webp 1536w,\n/static/9974a4bfa9c09de714f8534014cc1eec/0b2ca/static_cache.webp 2598w\"\n              sizes=\"(max-width: 768px) 100vw, 768px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9974a4bfa9c09de714f8534014cc1eec/150b2/static_cache.jpg 192w,\n/static/9974a4bfa9c09de714f8534014cc1eec/6985d/static_cache.jpg 384w,\n/static/9974a4bfa9c09de714f8534014cc1eec/19de6/static_cache.jpg 768w,\n/static/9974a4bfa9c09de714f8534014cc1eec/4472f/static_cache.jpg 1152w,\n/static/9974a4bfa9c09de714f8534014cc1eec/d58d1/static_cache.jpg 1536w,\n/static/9974a4bfa9c09de714f8534014cc1eec/d057b/static_cache.jpg 2598w\"\n            sizes=\"(max-width: 768px) 100vw, 768px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9974a4bfa9c09de714f8534014cc1eec/19de6/static_cache.jpg\"\n            alt=\"Image\"\n            title=\"image\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n<em>대규모 시스템 설계 기초</em></p>\n<h3>3. GC에서 제외된다.</h3>\n<p>static으로 선언 시 GC에서 제외된다는 것은, GC 가 관리해 주지 않는다는 것이고</p>\n<p>이는 곧 잘 못 관리 시 Memory Leak 가 발생한다는 것이다.</p>\n<p>따라서 static 변수가 메모리에서 차지하는 공간을 불확실하게 둘 수 있는 자료구조를 사용하는 것을 주의해야 한다.<br>\n그렇기에 HashMap, ArrayList 와 같이 선언 시 길이를 할당하지 않는 Collection 객체를 static 으로 선언하면\nOutOfMemoryError 를 뱉어내며, 서버가 죽게 된다.</p>\n<p>따라서 반대로 모니터링 시 계속해서 GC 이후의 최저 메모리 사용량이 증가하게 되면 해당 문제를 의심해 볼 수도 있다.</p>\n<br>\n<p><em>번외</em></p>\n<p>위의 주의점 들을 고려할 때, 얻어 갈 수 있는 관점은<br>\n테스트 시 단일 사용자, 단일 WAS에서 발생하는 트래픽만을 고려하는 것이 아닌</p>\n<ul>\n<li>MSA 구조를 통해, 여러 대 올라가는 WAS</li>\n<li>당연하겠지만, 다수의 Client 에서 발생하는 접근</li>\n</ul>\n<p>을 고려하여 테스트해봐야 한다.</p>\n<blockquote>\n<p>reference</p>\n<ul>\n<li><a href=\"https://product.kyobobook.co.kr/detail/S000001032977\" target=\"_blank\" rel=\"nofollow\">자바 성능 튜닝 이야기 - static 제대로 한번 써보자</a></li>\n<li><a href=\"https://product.kyobobook.co.kr/detail/S000001033116\" target=\"_blank\" rel=\"nofollow\">가상 면접 사례로 배우는 대규모 시스템 설계 기초</a></li>\n</ul>\n</blockquote>\n<blockquote>\n<p>부족한 글 읽어주셔서 진심으로 감사드리며, 잘못된 부분이나 개선점은 무심하게 라도 알려주시면 너무 감사하겠습니다.</p>\n</blockquote>","frontmatter":{"title":"static 을 통한 성능 고도화 및  multi thread 고려 등의 주의점","summary":"static 을 통해서 얻을 수 있는 명확한 이점과, 그에 반해 발생하는 무수한 주의점을 타파해서 멋있어지자","date":"2023.08.05.","categories":["Java"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAANABQDASIAAhEBAxEB/8QAGgAAAQUBAAAAAAAAAAAAAAAAAAMEBQYHCP/EABYBAQEBAAAAAAAAAAAAAAAAAAUDBP/aAAwDAQACEAMQAAAB4Jc4zRc9YcREzP/EABwQAAAHAQEAAAAAAAAAAAAAAAABAgMEBQYHEv/aAAgBAQABBQLEvZGrTtekTr4OqI1NVrCYM+WmQPQ//8QAHhEAAgICAgMAAAAAAAAAAAAAAQIREgADBBMhMVH/2gAIAQMBAT8Bft0cdFJXXdA6osl3U+LEgVUGPVrfQBhgmc//xAAeEQACAgICAwAAAAAAAAAAAAABAgMSABETISIxQf/aAAgBAgEBPwGPinnZlDSUYo7nSqjADxAJuxG/da/Qd4Ohn//EACkQAAICAQIEBAcAAAAAAAAAAAECAxESEyEABAUUFSIyMyMxQVFjceH/2gAIAQEABj8CXn+t+IPzcTlligXl2gIFaXuHPL1F72sKB8yR2kLyw9JjOEUEfwrgsgXja6jKDvRAb6GuLTKvyEFr/a4j+3w/UJ2l5hYpI17bPRV8tvNIgzq2B8mJ2rLfhNKHt41jjUJqNKdhXuMAxsoDRv7+vN34/8QAHBABAAIDAQEBAAAAAAAAAAAAAREhADFRgUHB/9oACAEBAAE/IZDF4XVQLxxZkKm/pJNMCUqxoZitJi11a4UEj5Ox5A6K4KLI7UKfeE4MD53lBGEKQcvE9Brnv7n/2gAMAwEAAgADAAAAEBwP/8QAGhEBAQEAAwEAAAAAAAAAAAAAAREhADFRQf/aAAgBAwEBPxDum5iSN5QtOSJalOtwQrHowM+evvP/xAAZEQEBAAMBAAAAAAAAAAAAAAABESExQfD/2gAIAQIBAT8QYg3WlsVCICVpoBAxgNlebe693//EABkQAQEBAQEBAAAAAAAAAAAAAAERIQAxUf/aAAgBAQABPxDCYuMPKeIhaflVshdEHBR6U4tm0g0TVsi9fsMOWm26saQ2z7QH3grRACd2Pl4n6srQFAW1UiVUsg/LV//Z"},"images":{"fallback":{"src":"/static/93f5908ec7d2b74d10420c339bb310b8/2a19d/static_thum.jpg","srcSet":"/static/93f5908ec7d2b74d10420c339bb310b8/6588d/static_thum.jpg 1500w,\n/static/93f5908ec7d2b74d10420c339bb310b8/88700/static_thum.jpg 3000w,\n/static/93f5908ec7d2b74d10420c339bb310b8/2a19d/static_thum.jpg 6000w","sizes":"(min-width: 6000px) 6000px, 100vw"},"sources":[{"srcSet":"/static/93f5908ec7d2b74d10420c339bb310b8/f77da/static_thum.webp 1500w,\n/static/93f5908ec7d2b74d10420c339bb310b8/cf4ae/static_thum.webp 3000w,\n/static/93f5908ec7d2b74d10420c339bb310b8/955c8/static_thum.webp 6000w","type":"image/webp","sizes":"(min-width: 6000px) 6000px, 100vw"}]},"width":6000,"height":4000}},"publicURL":"/static/93f5908ec7d2b74d10420c339bb310b8/static_thum.jpg"}}}}]}},"pageContext":{"slug":"/static 과 Thread/"}},"staticQueryHashes":[]}